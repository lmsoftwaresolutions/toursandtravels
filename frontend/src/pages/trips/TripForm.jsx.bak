import { useEffect, useState } from "react";
import { useNavigate, useParams } from "react-router-dom";
import api from "../../services/api";

export default function TripForm() {
  const navigate = useNavigate();
  const { id } = useParams();
  const isEdit = Boolean(id);

  const [drivers, setDrivers] = useState([]);
  const [vehicles, setVehicles] = useState([]);
  const [customers, setCustomers] = useState([]);
  const [vendors, setVendors] = useState([]);
  const [showOtherVendor, setShowOtherVendor] = useState(false);

  const [form, setForm] = useState({
    trip_date: "",
    from_location: "",
    to_location: "",
    vehicle_number: "",
    driver_id: "",
    customer_id: "",
    distance_km: "",
    fuel_cost: "",
    toll_amount: "", // hidden expense, kept for edits
    parking_amount: "", // hidden expense, kept for edits
    other_expenses: "",
    cost_per_km: "",
    charged_toll_amount: "",
    charged_parking_amount: "",
    amount_received: "",
    vendor: "",
  });

  /* ---------------- LOAD DROPDOWNS ---------------- */
  useEffect(() => {
    api.get("/vehicles").then(res => setVehicles(res.data));
    api.get("/drivers").then(res => setDrivers(res.data));
    api.get("/customers").then(res => setCustomers(res.data));
    api.get("/vendors", { params: { category: "fuel" } }).then(res => setVendors(res.data));
  }, []);

  /* ---------------- LOAD TRIP (EDIT MODE) ---------------- */
  useEffect(() => {
    if (isEdit) {
      api.get(`/trips/${id}`).then(res => {
        const data = res.data;

        setForm({
          trip_date: data.trip_date,          // YYYY-MM-DD
          from_location: data.from_location,
          to_location: data.to_location,
          vehicle_number: data.vehicle_number,
          driver_id: String(data.driver_id),   // ✅ FIX
          customer_id: String(data.customer_id), // ✅ FIX
          distance_km: data.distance_km,
          fuel_cost: (data.diesel_used || data.petrol_used || ""),
          toll_amount: data.toll_amount || "",
          parking_amount: data.parking_amount || "",
          other_expenses: data.other_expenses || "",
          cost_per_km: data.cost_per_km || "",
          charged_toll_amount: data.charged_toll_amount || "",
          charged_parking_amount: data.charged_parking_amount || "",
          amount_received: data.amount_received || "",
          vendor: data.vendor || "",
        });

        // Check if vendor is "other"
        if (data.vendor && !vendors.find(v => v.name === data.vendor)) {
          setShowOtherVendor(true);
        }
      });
    }
  }, [id, isEdit]);

  /* ---------------- HANDLE CHANGE ---------------- */
  const handleChange = (e) => {
    const { name, value } = e.target;
    
    if (name === "vendor" && value === "other") {
      setShowOtherVendor(true);
      setForm({ ...form, vendor: "" });
    } else {
      setForm({ ...form, [name]: value });
    }
  };

  /* ---------------- SUBMIT ---------------- */
  const handleSubmit = async (e) => {
    e.preventDefault();

    const payload = {
      ...form,
      driver_id: Number(form.driver_id),
      customer_id: Number(form.customer_id),
      distance_km: Number(form.distance_km),
      diesel_used: Number(form.fuel_cost || 0),
      petrol_used: 0,
      toll_amount: Number(form.toll_amount || 0),
      parking_amount: Number(form.parking_amount || 0),
      other_expenses: Number(form.other_expenses || 0),
      cost_per_km: Number(form.cost_per_km || 0),
      charged_toll_amount: Number(form.charged_toll_amount || 0),
      charged_parking_amount: Number(form.charged_parking_amount || 0),
      amount_received: Number(form.amount_received || 0),
      vendor: form.vendor || null,
    };

    if (isEdit) {
      await api.put(`/trips/${id}`, payload);
      alert("Trip updated successfully");
    } else {
      await api.post("/trips", payload);
      alert("Trip created successfully");
    }

    navigate("/trips");
  };

  /* ---------------- UI ---------------- */
  return (
    <div className="p-6">
      <h1 className="text-2xl font-bold mb-6">
        {isEdit ? "Edit Trip" : "Add Trip"}
      </h1>

      <div className="max-w-3xl bg-white p-6 rounded shadow">
        <form className="grid grid-cols-2 gap-4" onSubmit={handleSubmit}>

          <div>
            <label className="block text-sm font-medium mb-1">Trip Date</label>
            <input
              type="date"
              name="trip_date"
              value={form.trip_date}
              onChange={handleChange}
              className="border p-2 w-full rounded"
              required
            />
          </div>

          <div>
            <label className="block text-sm font-medium mb-1">Distance (KM)</label>
            <input
              type="number"
              name="distance_km"
              value={form.distance_km}
              onChange={handleChange}
              className="border p-2 w-full rounded"
              required
            />
          </div>

          <div>
            <label className="block text-sm font-medium mb-1">From Location</label>
            <input
              name="from_location"
              value={form.from_location}
              onChange={handleChange}
              className="border p-2 w-full rounded"
              required
            />
          </div>

          <div>
            <label className="block text-sm font-medium mb-1">To Location</label>
            <input
              name="to_location"
              value={form.to_location}
              onChange={handleChange}
              className="border p-2 w-full rounded"
              required
            />
          </div>

          <div>
            <label className="block text-sm font-medium mb-1">Vehicle</label>
            <select
              name="vehicle_number"
              value={form.vehicle_number}
              onChange={handleChange}
              className="border p-2 w-full rounded"
              required
            >
              <option value="">Select Vehicle</option>
              {vehicles.map(v => (
                <option key={v.vehicle_number} value={v.vehicle_number}>
                  {v.vehicle_number}
                </option>
              ))}
            </select>
          </div>

          <div>
            <label className="block text-sm font-medium mb-1">Driver</label>
            <select
              name="driver_id"
              value={form.driver_id}
              onChange={handleChange}
              className="border p-2 w-full rounded"
              required
            >
              <option value="">Select Driver</option>
              {drivers.map(d => (
                <option key={d.id} value={d.id}>{d.name}</option>
              ))}
            </select>
          </div>

          <div className="col-span-2">
            <label className="block text-sm font-medium mb-1">Customer</label>
            <select
              name="customer_id"
              value={form.customer_id}
              onChange={handleChange}
              className="border p-2 w-full rounded"
              required
            >
              <option value="">Select Customer</option>
              {customers.map(c => (
                <option key={c.id} value={c.id}>{c.name}</option>
              ))}
            </select>
          </div>

          <div>
            <label className="block text-sm font-medium mb-1">Fuel Cost (₹)</label>
            <input
              type="number"
              step="0.01"
              name="fuel_cost"
              value={form.fuel_cost}
              onChange={handleChange}
              className="border p-2 w-full rounded"
            />
          </div>

          <div>
            <label className="block text-sm font-medium mb-1">Fuel Vendor</label>
            {showOtherVendor ? (
              <div className="flex gap-2">
                <input
                  type="text"
                  name="vendor"
                  placeholder="Enter vendor name"
                  value={form.vendor}
                  onChange={handleChange}
                  className="border p-2 w-full rounded"
                />
                <button
                  type="button"
                  onClick={() => {
                    setShowOtherVendor(false);
                    setForm({ ...form, vendor: "" });
                  }}
                  className="bg-gray-300 px-3 rounded text-sm"
                >
                  ✕
                </button>
              </div>
            ) : (
              <select
                name="vendor"
                value={form.vendor}
                onChange={handleChange}
                className="border p-2 w-full rounded"
              >
                <option value="">Select Vendor</option>
                {vendors.map(v => (
                  <option key={v.id} value={v.name}>
                    {v.name}
                  </option>
                ))}
                <option value="other">Other</option>
              </select>
            )}
          </div>

          <div>
            <label className="block text-sm font-medium mb-1">Cost per KM (to customer)</label>
            <input
              type="number"
              step="0.01"
              name="cost_per_km"
              value={form.cost_per_km}
              onChange={handleChange}
              className="border p-2 w-full rounded"
              required
            />
          </div>

          <div>
            <label className="block text-sm font-medium mb-1">Charged Toll</label>
            <input
              type="number"
              step="0.01"
              name="charged_toll_amount"
              value={form.charged_toll_amount}
              onChange={handleChange}
              className="border p-2 w-full rounded"
            />
          </div>

          <div>
            <label className="block text-sm font-medium mb-1">Charged Parking</label>
            <input
              type="number"
              step="0.01"
              name="charged_parking_amount"
              value={form.charged_parking_amount}
              onChange={handleChange}
              className="border p-2 w-full rounded"
            />
          </div>

          <div>
            <label className="block text-sm font-medium mb-1">Amount Received</label>
            <input
              type="number"
              step="0.01"
              name="amount_received"
              value={form.amount_received}
              onChange={handleChange}
              className="border p-2 w-full rounded"
            />
          </div>

          <div className="col-span-2 bg-gray-50 border rounded p-3 text-sm space-y-1">
            <p className="font-semibold">Billing Preview</p>
            <p className="text-xs text-gray-500">Note: Toll & parking paid on spot, not included in bill</p>
            <p>
              Total Charged: ₹{
                (Number(form.distance_km || 0) * Number(form.cost_per_km || 0)).toFixed(2)
              }
            </p>
            <p>
              Pending: ₹{
                Math.max(
                  (Number(form.distance_km || 0) * Number(form.cost_per_km || 0))
                  - Number(form.amount_received || 0),
                  0
                ).toFixed(2)
              }
            </p>
          </div>

          <div className="col-span-2">
            <label className="block text-sm font-medium mb-1">Other Expenses</label>
            <input
              type="number"
              name="other_expenses"
              value={form.other_expenses}
              onChange={handleChange}
              className="border p-2 w-full rounded"
            />
          </div>

          <div className="col-span-2 pt-4">
            <button className="bg-blue-600 text-white py-2 rounded w-full">
              {isEdit ? "Update Trip" : "Save Trip"}
            </button>
          </div>

        </form>
      </div>
    </div>
  );
}
